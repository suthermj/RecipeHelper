@* Views/Import/MappedImportedRecipe.cshtml *@
@model RecipeHelper.ViewModels.MappedImportedRecipeVM

@{
    ViewData["Title"] = "Map Imported Recipe";
    var krogerImgBase = "https://www.kroger.com/product/images/large/front/";
    var placeholderProductImg = Url.Content("~/images/default-product.png");
}

<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-3 pb-6 space-y-6">

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800">
            <div class="font-semibold mb-1">Please fix the following:</div>
            <ul class="list-disc pl-5 space-y-0.5">
                @foreach (var ms in ViewData.ModelState.Values)
                {
                    foreach (var e in ms.Errors)
                    {
                        <li>@e.ErrorMessage</li>
                    }
                }
            </ul>
        </div>
    }

    <header class="space-y-1">
        <h1 class="text-xl font-bold text-gray-900 sm:text-2xl">Map imported recipe</h1>
        <p class="text-sm text-gray-600">
            Mapping to Kroger is optional. You can import the recipe without selecting items.
        </p>

        @if (TempData["ErrorMessage"] is string err && !string.IsNullOrWhiteSpace(err))
        {
            <div class="mt-3 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800">
                <span class="font-semibold">⚠️ </span>@err
            </div>
        }
    </header>

    <form asp-action="SaveImportedRecipe" method="post" class="space-y-5">
        @Html.AntiForgeryToken()

        @* Recipe summary *@
        <section class="bg-white rounded-2xl border border-gray-200 p-4 sm:p-5 flex gap-4">
            <div class="h-20 w-20 sm:h-24 sm:w-24 flex-shrink-0 overflow-hidden rounded-xl bg-gray-100">
                <img src="@(string.IsNullOrWhiteSpace(Model.Image) ? Url.Content("~/images/default-recipe.png") : Model.Image)"
                     alt="@Model.Title"
                     class="h-full w-full object-cover" />
            </div>

            <div class="flex-1 space-y-2">
                <label for="recipeTitleInput" class="text-xs font-semibold uppercase tracking-wide text-gray-500">
                    Recipe title
                </label>

                <input id="recipeTitleInput"
                       name="Title"
                       type="text"
                       value="@Model.Title"
                       class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm sm:text-base font-semibold text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500"
                       maxlength="120"
                       autocomplete="off" />

                <p class="text-[0.7rem] text-gray-500">You can rename this before importing.</p>
            </div>
        </section>

        <input type="hidden" name="Image" value="@Model.Image" />

        @* Ingredient cards *@
        <section class="space-y-4">
            @for (var i = 0; i < Model.Ingredients.Count; i++)
            {
                var ing = Model.Ingredients[i];

                var hasSelected = !string.IsNullOrWhiteSpace(ing.SelectedUpc);
                var hasSuggested = !string.IsNullOrWhiteSpace(ing.SuggestedUpc) && !string.IsNullOrWhiteSpace(ing.SuggestedName);

                var currentSource = hasSelected ? (ing.SelectedSource ?? "Kroger")
                : (hasSuggested ? "Suggested" : "Unselected");

                var currentName = hasSelected ? (ing.SelectedName ?? "")
                : (hasSuggested ? (ing.SuggestedName ?? "") : "No item selected");

                var currentUpc = hasSelected ? ing.SelectedUpc
                : (hasSuggested ? ing.SuggestedUpc : "");

                var currentImg = !string.IsNullOrWhiteSpace(currentUpc)
                ? (krogerImgBase + currentUpc)
                : placeholderProductImg;

                <div class="js-row rounded-2xl border border-gray-200 bg-white p-4 sm:p-5 shadow-sm transition"
                     data-idx="@i">

                    @* ✅ Editable ingredient name (replaces hidden Name) *@
                    <input type="hidden" name="Ingredients[@i].Include" value="@(ing.Include ? "true" : "false")" class="js-include" data-idx="@i" />

                    <input type="hidden" name="Ingredients[@i].IngredientId" value="@(ing.IngredientId ?? 0)" />
                    <input type="hidden" name="Ingredients[@i].CanonicalName" value="@(ing.CanonicalName ?? "")" />
                    <input type="hidden" name="Ingredients[@i].IngredientMatchKind" value="@(ing.IngredientMatchKind ?? "")" />

                    @* Persist suggestions *@
                    <input type="hidden" name="Ingredients[@i].SuggestedUpc" value="@(ing.SuggestedUpc ?? "")" />
                    <input type="hidden" name="Ingredients[@i].SuggestedName" value="@(ing.SuggestedName ?? "")" />

                    @* Persist final selection *@
                    <input type="hidden" name="Ingredients[@i].SelectedUpc" value="@(ing.SelectedUpc ?? "")" class="js-selected-upc" data-idx="@i" />
                    <input type="hidden" name="Ingredients[@i].SelectedName" value="@(ing.SelectedName ?? "")" class="js-selected-name" data-idx="@i" />
                    <input type="hidden" name="Ingredients[@i].SelectedSource" value="@(ing.SelectedSource ?? "")" class="js-selected-source" data-idx="@i" />

                    @* Persist Kroger fallback suggestion (from API search) *@
                    <input type="hidden" name="Ingredients[@i].Kroger.Upc" value="@(ing.Kroger?.Upc ?? "")" />
                    <input type="hidden" name="Ingredients[@i].Kroger.Name" value="@(ing.Kroger?.Name ?? "")" />
                    <input type="hidden" name="Ingredients[@i].Kroger.ImageUrl" value="@(ing.Kroger?.ImageUrl ?? "")" />

                    @* Header row *@
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1">

                            @* ✅ Editable name input *@
                            <label class="block text-[0.7rem] font-semibold uppercase tracking-wide text-gray-500">
                                Ingredient
                            </label>
                            <input type="text"
                                   name="Ingredients[@i].Name"
                                   value="@ing.Name"
                                   class="js-ingredient-name mt-1 w-full max-w-xl rounded-md border border-gray-300 px-3 py-2 text-sm font-semibold text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500"
                                   data-idx="@i"
                                   maxlength="120"
                                   autocomplete="off" />

                            <div class="mt-2 flex flex-wrap items-center gap-2">
                                <span class="text-[0.7rem] font-semibold uppercase tracking-wide text-gray-500">Quantity</span>

                                <input type="number"
                                       step="0.01"
                                       min="0"
                                       name="Ingredients[@i].Amount"
                                       value="@(ing.Amount ?? 0m)"
                                       class="js-amount w-24 rounded-md border border-gray-300 px-2 py-1 text-sm text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500"
                                       data-idx="@i" />

                                <select asp-for="Ingredients[@i].Unit"
                                        asp-items="Model.AvailableMeasurements"
                                        class="js-unit w-32 rounded-md border border-gray-300 px-2 py-1 text-sm text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500"
                                        data-idx="@i">
                                </select>

                                <span class="ml-2 text-[0.7rem] text-gray-500">(Mapping optional)</span>
                            </div>

                            <div class="mt-2 hidden js-excluded-badge text-[0.7rem] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 inline-flex items-center gap-1"
                                 data-idx="@i">
                                <span class="inline-block w-1.5 h-1.5 rounded-full bg-gray-500"></span>
                                Excluded from recipe
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button type="button"
                                    class="js-open-map inline-flex items-center rounded-full bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-1 text-xs font-semibold hover:bg-indigo-100"
                                    data-idx="@i">
                                Map item
                            </button>

                            <button type="button"
                                    class="js-exclude-btn inline-flex items-center rounded-full border border-gray-300 px-3 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50"
                                    data-idx="@i"
                                    aria-pressed="false">
                                Exclude
                            </button>
                        </div>
                    </div>

                    @* Compact current selection display *@
                    <div class="mt-4 rounded-2xl border border-gray-200 bg-white p-4 flex items-center gap-3">
                        <div class="h-14 w-14 flex-shrink-0 overflow-hidden rounded-md bg-gray-100 border border-gray-200">
                            <img id="currentImg-@i" src="@currentImg" alt="Selected product image" class="h-full w-full object-cover" />
                        </div>

                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-semibold uppercase tracking-wide text-gray-500">Selection</span>
                                <span id="currentBadge-@i"
                                      class="px-2 py-0.5 text-[0.65rem] rounded-full border
                                                @(currentSource == "Kroger" ? "bg-purple-50 text-purple-700 border-purple-200"
                                                                                    : currentSource == "Suggested" ? "bg-emerald-50 text-emerald-700 border-emerald-200"
                                                                                    : currentSource == "My products" ? "bg-indigo-50 text-indigo-700 border-indigo-200"
                                                                                    : "bg-gray-50 text-gray-600 border-gray-200")">
                                @currentSource
                            </span>
                        </div>

                            <div id="currentName-@i" class="mt-1 text-sm font-semibold text-gray-900 truncate">
                                @currentName
                            </div>

                            <div id="currentMeta-@i" class="text-xs text-gray-500 truncate">
                                @(string.IsNullOrWhiteSpace(currentUpc) ? "No UPC selected" : $"UPC: {currentUpc}")
                            </div>
                        </div>

                        <button type="button"
                                class="js-clear-selection inline-flex items-center rounded-full border border-gray-300 px-3 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50"
                                data-idx="@i"
                                @(hasSelected ? "" : "disabled")
                                title="Clear selection">
                            Clear
                        </button>
                    </div>
                </div>
                        }
        </section>

        <div class="flex justify-end gap-3 pt-2">
            <a href="@Url.Action("ImportRecipe", "Import")"
               class="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                ← Back
            </a>
            <button type="submit"
                    class="inline-flex items-center justify-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700">
                Confirm mapping
            </button>
        </div>
    </form>
</div>

@* ---------- Mapping Modal (shared) ---------- *@
<div id="mapModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div class="js-modal-backdrop absolute inset-0 bg-black/40"></div>

    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-2xl rounded-2xl bg-white shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-start justify-between gap-3">
                <div>
                    <div class="text-sm font-semibold text-gray-900">Map ingredient to item</div>
                    <div id="modalIngredientName" class="text-xs text-gray-500 mt-0.5">—</div>
                </div>
                <button type="button"
                        class="js-close-modal rounded-full border border-gray-300 px-3 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50">
                    Close
                </button>
            </div>

            <div class="px-5 py-4 space-y-4">

                @* ✅ Pinned suggestion (hidden when not available) *@
                <div id="modalPinnedWrap" class="hidden">
                    <div class="text-[0.7rem] font-semibold uppercase tracking-wide text-gray-500 mb-2">
                        Recommended
                    </div>

                    <button type="button"
                            id="modalPinnedBtn"
                            class="w-full text-left rounded-xl border border-emerald-200 bg-emerald-50 hover:bg-emerald-100 transition p-3 flex items-center gap-3">
                        <img id="modalPinnedImg"
                             src="@placeholderProductImg"
                             class="h-10 w-10 rounded object-cover border border-emerald-200 bg-white flex-shrink-0"
                             alt="" />
                        <div class="min-w-0 flex-1">
                            <div id="modalPinnedName" class="text-sm font-semibold text-emerald-900 truncate">—</div>
                            <div id="modalPinnedMeta" class="text-xs text-emerald-800 truncate">—</div>
                        </div>
                        <span class="text-xs font-semibold text-emerald-900">Use</span>
                    </button>

                    <div class="mt-3 border-t border-gray-100"></div>
                </div>

                @* Tabs *@
                <div class="flex items-center justify-between">
                    <div class="inline-flex rounded-full bg-gray-100 p-0.5 text-xs">
                        <button type="button"
                                class="js-modal-tab px-3 py-1 rounded-full font-semibold bg-white text-gray-900 shadow-sm"
                                data-mode="db">
                            My products
                        </button>
                        <button type="button"
                                class="js-modal-tab px-3 py-1 rounded-full font-semibold text-gray-500"
                                data-mode="kroger">
                            Kroger
                        </button>
                    </div>

                    <button type="button"
                            class="js-modal-clear inline-flex items-center rounded-full border border-gray-300 px-3 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50">
                        Clear selection
                    </button>
                </div>

                @* Search *@
                <div class="space-y-1">
                    <div class="relative">
                        <input id="modalSearch"
                               type="text"
                               placeholder="Search…"
                               class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500"
                               autocomplete="off" />
                        <div id="modalHint" class="mt-1 text-[0.7rem] text-gray-500">
                            Searching your saved products.
                        </div>
                    </div>
                </div>

                @* Results *@
                <div class="border border-gray-200 rounded-xl overflow-hidden">
                    <div id="modalResultsEmpty" class="p-4 text-sm text-gray-500">
                        Type at least 2 characters to search.
                    </div>
                    <ul id="modalResults" class="divide-y divide-gray-100 hidden max-h-80 overflow-auto"></ul>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-between">
                <div class="text-[0.7rem] text-gray-500">
                    Tip: choosing an item is optional. You can import without mapping.
                </div>
                <button type="button"
                        class="js-close-modal inline-flex items-center justify-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const dbSearchUrl = '@Url.Action("SearchDb", "Product")';
        const krogerSearchUrl = '@Url.Action("SearchKroger", "Product")';
        const debounceMs = 200;

        const placeholderProductImg = '@Url.Content("~/images/default-product.png")';
        const krogerImgBase = 'https://www.kroger.com/product/images/large/front/';

        // Modal state
        let activeIdx = null;
        let activeMode = 'db';

        const modal = document.getElementById('mapModal');
        const modalIngredientName = document.getElementById('modalIngredientName');
        const modalSearch = document.getElementById('modalSearch');
        const modalHint = document.getElementById('modalHint');
        const modalResults = document.getElementById('modalResults');
        const modalResultsEmpty = document.getElementById('modalResultsEmpty');

        // Pinned elements
        const pinnedWrap = document.getElementById('modalPinnedWrap');
        const pinnedBtn = document.getElementById('modalPinnedBtn');
        const pinnedImg = document.getElementById('modalPinnedImg');
        const pinnedName = document.getElementById('modalPinnedName');
        const pinnedMeta = document.getElementById('modalPinnedMeta');

        function debounce(fn, ms) {
            let t;
            return function (...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), ms);
            };
        }

        function imgFromUpc(upc) {
            const u = (upc || '').trim();
            return u ? (krogerImgBase + u) : placeholderProductImg;
        }

        function getIngredientName(idx) {
            // ✅ now reads the editable input
            return document.querySelector(`input.js-ingredient-name[data-idx="${idx}"]`)?.value
                || document.querySelector(`input[name="Ingredients[${idx}].Name"]`)?.value
                || '';
        }

        function openModal(idx) {
            activeIdx = idx;

            modalIngredientName.textContent = getIngredientName(idx) || '—';

            modal.classList.remove('hidden');
            modal.setAttribute('aria-hidden', 'false');

            modalSearch.value = '';
            setResults([]);
            setEmptyMessage('Type at least 2 characters to search.');

            setMode(activeMode || 'db');

            hydratePinnedSuggestion(idx);

            setTimeout(() => modalSearch.focus(), 0);
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.setAttribute('aria-hidden', 'true');
            activeIdx = null;
        }

        function setMode(mode) {
            activeMode = mode;

            document.querySelectorAll('.js-modal-tab').forEach(btn => {
                const isActive = btn.dataset.mode === mode;
                btn.classList.toggle('bg-white', isActive);
                btn.classList.toggle('text-gray-900', isActive);
                btn.classList.toggle('shadow-sm', isActive);
                btn.classList.toggle('text-gray-500', !isActive);
            });

            modalHint.textContent = (mode === 'db')
                ? 'Searching your saved products.'
                : 'Searching Kroger catalog (may take a moment).';

            setResults([]);
            setEmptyMessage('Type at least 2 characters to search.');
            modalSearch.value = '';
            modalSearch.focus();
        }

        function setEmptyMessage(text) {
            modalResultsEmpty.textContent = text;
            modalResultsEmpty.classList.remove('hidden');
            modalResults.classList.add('hidden');
            modalResults.innerHTML = '';
        }

        function setResults(items) {
            modalResults.innerHTML = '';

            if (!Array.isArray(items) || items.length === 0) {
                modalResults.classList.add('hidden');
                modalResultsEmpty.classList.remove('hidden');
                return;
            }

            modalResultsEmpty.classList.add('hidden');
            modalResults.classList.remove('hidden');

            items.slice(0, 20).forEach(it => {
                const upc = (it.upc || '').toString();
                const name = it.name || '';

                const li = document.createElement('li');
                li.className = 'px-4 py-3 hover:bg-indigo-50 cursor-pointer flex items-center gap-3';

                const img = document.createElement('img');
                img.src = imgFromUpc(upc);
                img.alt = name;
                img.className = 'h-10 w-10 rounded object-cover flex-shrink-0 border border-gray-200 bg-gray-100';
                li.appendChild(img);

                const col = document.createElement('div');
                col.className = 'min-w-0 flex-1';

                const title = document.createElement('div');
                title.className = 'text-sm font-semibold text-gray-900 truncate';
                title.textContent = name;
                col.appendChild(title);

                const meta = document.createElement('div');
                meta.className = 'text-xs text-gray-500 truncate';
                meta.textContent = upc ? `UPC: ${upc}` : '';
                col.appendChild(meta);

                li.appendChild(col);

                li.dataset.upc = upc;
                li.dataset.name = name;
                li.dataset.source = (activeMode === 'db') ? 'My products' : 'Kroger';

                modalResults.appendChild(li);
            });
        }

        function setHiddenSelection(idx, upc, name, source) {
            const upcH = document.querySelector(`input.js-selected-upc[data-idx="${idx}"]`);
            const nameH = document.querySelector(`input.js-selected-name[data-idx="${idx}"]`);
            const srcH = document.querySelector(`input.js-selected-source[data-idx="${idx}"]`);
            if (upcH) upcH.value = upc || '';
            if (nameH) nameH.value = name || '';
            if (srcH) srcH.value = source || '';
        }

        function setCurrentSelection(idx, { source, name, upc }) {
            const imgEl = document.getElementById(`currentImg-${idx}`);
            const nameEl = document.getElementById(`currentName-${idx}`);
            const badgeEl = document.getElementById(`currentBadge-${idx}`);
            const metaEl = document.getElementById(`currentMeta-${idx}`);

            if (imgEl) imgEl.src = imgFromUpc(upc);
            if (nameEl) nameEl.textContent = name || 'No item selected';
            if (metaEl) metaEl.textContent = upc ? `UPC: ${upc}` : 'No UPC selected';

            if (badgeEl) {
                badgeEl.textContent = source || 'Selected';
                badgeEl.className =
                    'px-2 py-0.5 text-[0.65rem] rounded-full border ' +
                    (source === 'Kroger'
                        ? 'bg-purple-50 text-purple-700 border-purple-200'
                        : (source === 'My products')
                            ? 'bg-indigo-50 text-indigo-700 border-indigo-200'
                            : (source === 'Suggested')
                                ? 'bg-emerald-50 text-emerald-700 border-emerald-200'
                                : 'bg-gray-50 text-gray-600 border-gray-200');
            }
        }

        // Pinned suggestion hydrator (Suggested first, then Kroger fallback)
        function hydratePinnedSuggestion(idx) {
            const sugUpc = document.querySelector(`input[name="Ingredients[${idx}].SuggestedUpc"]`)?.value || '';
            const sugName = document.querySelector(`input[name="Ingredients[${idx}].SuggestedName"]`)?.value || '';

            const kUpc = document.querySelector(`input[name="Ingredients[${idx}].Kroger.Upc"]`)?.value || '';
            const kName = document.querySelector(`input[name="Ingredients[${idx}].Kroger.Name"]`)?.value || '';

            let upc = '';
            let name = '';
            let source = '';

            if (sugUpc.trim() && sugName.trim()) {
                upc = sugUpc.trim();
                name = sugName.trim();
                source = 'Suggested';
            } else if (kUpc.trim() && kName.trim()) {
                upc = kUpc.trim();
                name = kName.trim();
                source = 'Kroger';
            } else {
                pinnedWrap.classList.add('hidden');
                pinnedBtn.dataset.upc = '';
                pinnedBtn.dataset.name = '';
                pinnedBtn.dataset.source = '';
                return;
            }

            pinnedWrap.classList.remove('hidden');
            pinnedImg.src = imgFromUpc(upc);
            pinnedName.textContent = name;
            pinnedMeta.textContent = `UPC: ${upc} • ${source}`;
            pinnedBtn.dataset.upc = upc;
            pinnedBtn.dataset.name = name;
            pinnedBtn.dataset.source = source;
        }

        pinnedBtn.addEventListener('click', () => {
            if (activeIdx == null) return;

            const upc = pinnedBtn.dataset.upc || '';
            const name = pinnedBtn.dataset.name || '';
            const source = pinnedBtn.dataset.source || 'Suggested';
            if (!upc.trim()) return;

            setHiddenSelection(activeIdx, upc, name, source);
            setCurrentSelection(activeIdx, { source, name, upc });

            const rowClear = document.querySelector(`.js-clear-selection[data-idx="${activeIdx}"]`);
            if (rowClear) rowClear.removeAttribute('disabled');

            closeModal();
        });

        // Open modal
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.js-open-map');
            if (!btn) return;

            const idx = btn.dataset.idx;
            activeMode = 'db';
            openModal(idx);
        });

        // Keep modal subtitle in sync if user edits ingredient name while modal is open
        document.addEventListener('input', (e) => {
            const inp = e.target;
            if (!inp.classList || !inp.classList.contains('js-ingredient-name')) return;

            const idx = inp.dataset.idx;
            if (activeIdx != null && String(activeIdx) === String(idx) && !modal.classList.contains('hidden')) {
                modalIngredientName.textContent = inp.value.trim() || '—';
            }
        });

        // Close modal + backdrop
        document.addEventListener('click', (e) => {
            if (e.target.closest('.js-close-modal')) closeModal();
            if (e.target.closest('.js-modal-backdrop')) closeModal();
        });

        // ESC closes modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
        });

        // Tabs
        document.addEventListener('click', (e) => {
            const tab = e.target.closest('.js-modal-tab');
            if (!tab) return;
            setMode(tab.dataset.mode || 'db');
        });

        // Clear selection from modal
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.js-modal-clear');
            if (!btn) return;
            if (activeIdx == null) return;

            setHiddenSelection(activeIdx, '', '', 'Unselected');

            const suggestedUpc = document.querySelector(`input[name="Ingredients[${activeIdx}].SuggestedUpc"]`)?.value || '';
            const suggestedName = document.querySelector(`input[name="Ingredients[${activeIdx}].SuggestedName"]`)?.value || '';

            if (suggestedUpc.trim()) {
                setCurrentSelection(activeIdx, { source: 'Suggested', name: suggestedName, upc: suggestedUpc });
            } else {
                setCurrentSelection(activeIdx, { source: 'Unselected', name: 'No item selected', upc: '' });
            }

            closeModal();
        });

        // Row-level clear button
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.js-clear-selection');
            if (!btn) return;

            const idx = btn.dataset.idx;
            const upcH = document.querySelector(`input.js-selected-upc[data-idx="${idx}"]`);
            if (!upcH || !upcH.value.trim()) return;

            setHiddenSelection(idx, '', '', 'Unselected');

            const suggestedUpc = document.querySelector(`input[name="Ingredients[${idx}].SuggestedUpc"]`)?.value || '';
            const suggestedName = document.querySelector(`input[name="Ingredients[${idx}].SuggestedName"]`)?.value || '';

            if (suggestedUpc.trim()) {
                setCurrentSelection(idx, { source: 'Suggested', name: suggestedName, upc: suggestedUpc });
            } else {
                setCurrentSelection(idx, { source: 'Unselected', name: 'No item selected', upc: '' });
            }

            btn.setAttribute('disabled', 'disabled');
        });

        // Search
        const runSearch = debounce(async () => {
            if (activeIdx == null) return;

            const q = (modalSearch.value || '').trim();
            if (q.length < 2) {
                setResults([]);
                setEmptyMessage('Type at least 2 characters to search.');
                return;
            }

            const url = (activeMode === 'kroger') ? krogerSearchUrl : dbSearchUrl;

            try {
                setEmptyMessage('Searching…');

                const resp = await fetch(`${url}?term=${encodeURIComponent(q)}`, {
                    headers: { 'Accept': 'application/json' }
                });
                if (!resp.ok) throw new Error('search failed');

                const items = await resp.json();
                if (!Array.isArray(items) || items.length === 0) {
                    setResults([]);
                    setEmptyMessage('No results found.');
                    return;
                }

                setResults(items);
            } catch {
                setResults([]);
                setEmptyMessage('Search failed. Try again.');
            }
        }, debounceMs);

        modalSearch.addEventListener('input', runSearch);

        // Pick result
        modalResults.addEventListener('click', (e) => {
            const li = e.target.closest('li');
            if (!li || activeIdx == null) return;

            const upc = li.dataset.upc || '';
            const name = li.dataset.name || '';
            const source = li.dataset.source || (activeMode === 'db' ? 'My products' : 'Kroger');

            setHiddenSelection(activeIdx, upc, name, source);
            setCurrentSelection(activeIdx, { source, name, upc });

            const rowClear = document.querySelector(`.js-clear-selection[data-idx="${activeIdx}"]`);
            if (rowClear) rowClear.removeAttribute('disabled');

            closeModal();
        });

        // Exclude/include
        function applyExcludedState(idx, excluded, { updateHidden = false } = {}) {
            const includeInput = document.querySelector(`input.js-include[data-idx="${idx}"]`);
            const badge = document.querySelector(`.js-excluded-badge[data-idx="${idx}"]`);
            const mapBtn = document.querySelector(`.js-open-map[data-idx="${idx}"]`);
            const clearBtn = document.querySelector(`.js-clear-selection[data-idx="${idx}"]`);

            const amountInput = document.querySelector(`.js-amount[data-idx="${idx}"]`);
            const unitSelect = document.querySelector(`.js-unit[data-idx="${idx}"]`);
            const nameInput = document.querySelector(`input.js-ingredient-name[data-idx="${idx}"]`);

            if (updateHidden && includeInput) includeInput.value = excluded ? 'false' : 'true';

            if (excluded) {
                if (badge) badge.classList.remove('hidden');
                if (mapBtn) mapBtn.classList.add('hidden');
                if (clearBtn) clearBtn.classList.add('hidden');
                if (amountInput) amountInput.disabled = true;
                if (unitSelect) unitSelect.disabled = true;
                if (nameInput) nameInput.disabled = true;
            } else {
                if (badge) badge.classList.add('hidden');
                if (mapBtn) mapBtn.classList.remove('hidden');
                if (clearBtn) clearBtn.classList.remove('hidden');
                if (amountInput) amountInput.disabled = false;
                if (unitSelect) unitSelect.disabled = false;
                if (nameInput) nameInput.disabled = false;
            }
        }

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.js-exclude-btn');
            if (!btn) return;

            const idx = btn.dataset.idx;
            const includeInput = document.querySelector(`input.js-include[data-idx="${idx}"]`);
            const isExcluded = (includeInput?.value === 'false');
            const nextExcluded = !isExcluded;

            btn.textContent = nextExcluded ? 'Include' : 'Exclude';
            btn.classList.toggle('bg-gray-100', nextExcluded);
            btn.setAttribute('aria-pressed', nextExcluded ? 'true' : 'false');

            applyExcludedState(idx, nextExcluded, { updateHidden: true });
        });

        // Init row current selection on load (and disable Clear if none selected)
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.js-row').forEach(row => {
                const idx = row.dataset.idx;

                const include = document.querySelector(`input.js-include[data-idx="${idx}"]`)?.value !== 'false';
                if (!include) {
                    applyExcludedState(idx, true, { updateHidden: false });
                    return;
                }

                const selectedUpc = document.querySelector(`input.js-selected-upc[data-idx="${idx}"]`)?.value || '';
                const selectedName = document.querySelector(`input.js-selected-name[data-idx="${idx}"]`)?.value || '';
                const selectedSource = document.querySelector(`input.js-selected-source[data-idx="${idx}"]`)?.value || '';

                const suggestedUpc = document.querySelector(`input[name="Ingredients[${idx}].SuggestedUpc"]`)?.value || '';
                const suggestedName = document.querySelector(`input[name="Ingredients[${idx}].SuggestedName"]`)?.value || '';

                if (selectedUpc.trim()) {
                    setCurrentSelection(idx, { source: selectedSource || 'Kroger', name: selectedName, upc: selectedUpc });
                } else if (suggestedUpc.trim()) {
                    setCurrentSelection(idx, { source: 'Suggested', name: suggestedName, upc: suggestedUpc });
                } else {
                    setCurrentSelection(idx, { source: 'Unselected', name: 'No item selected', upc: '' });
                }

                const rowClear = document.querySelector(`.js-clear-selection[data-idx="${idx}"]`);
                if (rowClear) {
                    if (selectedUpc.trim()) rowClear.removeAttribute('disabled');
                    else rowClear.setAttribute('disabled', 'disabled');
                }
            });
        });

    })();
</script>
