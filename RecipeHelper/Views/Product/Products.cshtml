@model List<ViewProductVM>

@{
    ViewData["Title"] = "Products";
    var imgBase = "https://www.kroger.com/product/images/large/front/";
}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-10">

    <!-- Top bar -->
    <div class="sticky top-0 z-10 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-3 bg-white/90 backdrop-blur border-b border-gray-200">
        <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
                <h1 class="text-lg sm:text-2xl font-bold text-gray-900 leading-tight">Products</h1>
                <p class="text-sm text-gray-600">@Model.Count product@(Model.Count == 1 ? "" : "s")</p>
            </div>

            <div class="flex items-center gap-2">
                <a href="@Url.Action("Recipe", "Recipe")"
                   class="inline-flex items-center justify-center rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50">
                    ← Back
                </a>

                <a href="@Url.Action("AddProduct", "Product")"
                   class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-700">
                    + Add
                </a>

                <!-- Filter icon button -->
                <button id="filterToggle"
                        type="button"
                        class="relative inline-flex items-center justify-center rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50"
                        aria-expanded="false"
                        aria-controls="filterPanel"
                        title="Filters">
                    <span class="sr-only">Filters</span>

                    <!-- funnel icon (inline SVG) -->
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M3 5h18M6 12h12M10 19h4"
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>

                    <!-- active dot -->
                    <span id="filterActiveDot"
                          class="hidden absolute -top-1 -right-1 h-2.5 w-2.5 rounded-full bg-indigo-600 ring-2 ring-white"></span>
                </button>
            </div>
        </div>

        <!-- Collapsible filters -->
        <div id="filterPanel" class="hidden mt-3">
            <div class="rounded-2xl border border-gray-200 bg-white p-3 flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
                <div class="relative w-full sm:max-w-md">
                    <input id="productSearch"
                           type="search"
                           placeholder="Search products…"
                           class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 pl-10 text-sm text-gray-900 placeholder:text-gray-400 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500" />
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">🔎</span>
                </div>

                <div class="flex gap-2">
                    <select id="sortSelect"
                            class="w-full sm:w-auto rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500">
                        <option value="name-asc">Name (A → Z)</option>
                        <option value="name-desc">Name (Z → A)</option>
                    </select>

                    <button id="clearSearch"
                            type="button"
                            class="inline-flex items-center justify-center rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50">
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (Model == null || Model.Count == 0)
    {
        <div class="mt-6 rounded-2xl border border-gray-200 bg-white p-8 text-center">
            <div class="text-lg font-semibold text-gray-900">No products yet</div>
            <p class="mt-1 text-sm text-gray-600">Add a product to start building your catalog.</p>
            <div class="mt-4">
                <a href="@Url.Action("AddProduct", "Product")"
                   class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700">
                    + Add product
                </a>
            </div>
        </div>
    }
    else
    {
        <!-- Mobile: list; Desktop: grid -->
        <div id="productsGrid" class="mt-5 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 sm:gap-4">
            @foreach (var product in Model)
            {
                <a href="@Url.Action("ViewProduct", "Product", new { productId = product.Id })"
                   class="product-card group rounded-2xl border border-gray-200 bg-white shadow-sm hover:shadow-md transition overflow-hidden"
                   data-name="@product.Name">

                    <div class="flex items-center gap-3 p-3 sm:p-4">
                        <div class="h-16 w-16 sm:h-20 sm:w-20 flex-shrink-0 rounded-xl bg-gray-100 overflow-hidden border border-gray-200">
                            <img src="@(imgBase + product.Upc)"
                                 alt="@product.Name"
                                 class="h-full w-full object-cover"
                                 loading="lazy"
                                 onerror="this.onerror=null; this.src='@Url.Content("~/images/default-product.png")';" />
                        </div>

                        <div class="min-w-0 flex-1">
                            <div class="text-sm sm:text-base font-semibold text-gray-900 leading-snug line-clamp-2">
                                @product.Name
                            </div>
                        </div>

                        <span class="text-gray-300 group-hover:text-indigo-500 transition">→</span>
                    </div>
                </a>
            }
        </div>

        <div id="noResults" class="hidden mt-6 rounded-2xl border border-gray-200 bg-white p-8 text-center">
            <div class="text-lg font-semibold text-gray-900">No results</div>
            <p class="mt-1 text-sm text-gray-600">Try a different search term.</p>
        </div>
    }
</div>

<script>
    (function () {
        const toggle = document.getElementById('filterToggle');
        const panel = document.getElementById('filterPanel');
        const activeDot = document.getElementById('filterActiveDot');

        const search = document.getElementById('productSearch');
        const clearBtn = document.getElementById('clearSearch');
        const sortSelect = document.getElementById('sortSelect');

        const grid = document.getElementById('productsGrid');
        const noResults = document.getElementById('noResults');

        function normalize(s) {
            return (s || '').toString().toLowerCase().trim();
        }

        function setActiveDot() {
            const q = normalize(search?.value);
            const sort = sortSelect?.value || 'name-asc';
            const active = !!q || sort !== 'name-asc';
            if (activeDot) activeDot.classList.toggle('hidden', !active);
        }

        if (toggle && panel) {
            toggle.addEventListener('click', () => {
                const isHidden = panel.classList.contains('hidden');
                panel.classList.toggle('hidden', !isHidden);
                toggle.setAttribute('aria-expanded', String(isHidden));
                if (isHidden) search?.focus();
            });
        }

        if (!grid) return;
        const cards = Array.from(grid.querySelectorAll('.product-card'));

        function applyFilterAndSort() {
            const q = normalize(search?.value);
            const sort = sortSelect?.value || 'name-asc';

            let visibleCount = 0;
            cards.forEach(c => {
                const name = normalize(c.dataset.name);
                const show = !q || name.includes(q);
                c.classList.toggle('hidden', !show);
                if (show) visibleCount++;
            });

            const visible = cards.filter(c => !c.classList.contains('hidden'));
            visible.sort((a, b) => {
                const an = a.dataset.name || '';
                const bn = b.dataset.name || '';
                return sort === 'name-desc' ? bn.localeCompare(an) : an.localeCompare(bn);
            });
            visible.forEach(c => grid.appendChild(c));

            if (noResults) noResults.classList.toggle('hidden', visibleCount !== 0);

            setActiveDot();
        }

        function debounce(fn, ms) {
            let t;
            return function (...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), ms);
            };
        }

        const onInput = debounce(applyFilterAndSort, 120);

        search?.addEventListener('input', onInput);
        sortSelect?.addEventListener('change', applyFilterAndSort);

        clearBtn?.addEventListener('click', () => {
            if (search) search.value = '';
            if (sortSelect) sortSelect.value = 'name-asc';
            applyFilterAndSort();
            search?.focus();
        });

        applyFilterAndSort();
    })();
</script>
